blueprint:
  name: Temperature Drop Notification
  description: Sends a notification when the temperature drops below a specified threshold, and repeats only if the temperature continues to drop after a set time.
  domain: automation
  input:
    temperature_sensor:
      name: Temperature Sensor
      description: The sensor that monitors the temperature.
      selector:
        entity:
          domain: sensor
          device_class: temperature
    temperature_threshold:
      name: Temperature Threshold
      description: Minimum temperature below which a notification will be sent.
      default: 18
      selector:
        number:
          min: -20
          max: 50
          unit_of_measurement: °C
    notification_message:
      name: Notification Message
      description: The message that will be sent when the temperature drops below the threshold.
      default: "Warning! Temperature has dropped below the threshold."
      selector:
        text:
    delay_between_notifications:
      name: Time Between Notifications (in minutes)
      description: The minimum time (in minutes) between notifications if the temperature keeps dropping.
      default: 30
      selector:
        number:
          min: 1
          max: 120
          unit_of_measurement: minutes

trigger:
  - platform: numeric_state
    entity_id: !input temperature_sensor
    below: !input temperature_threshold

action:
  - alias: "Send Temperature Drop Notification"
    service: notify.notify
    data:
      message: !input notification_message

  - alias: "Check if Temperature Continues to Drop"
    wait_for_trigger:
      - platform: numeric_state
        entity_id: !input temperature_sensor
        below: "{{ states('sensor.' + temperature_sensor.entity_id.split('.')[1]) | float - 0.5 }}"
    timeout: 
      minutes: !input delay_between_notifications
    continue_on_timeout: false

  - alias: "Send Follow-up Notification"
    service: notify.notify
    data:
      message: "Temperature continues to drop: {{ states(temperature_sensor) }}°C"
